{% extends 'quali_defect_app/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'quali_defect_app/css/auth.css' %}">
{% endblock %}

{% block content %}

<div class="qs-auth-container">
    <div class="qs-auth-card">

        <h1 class="qs-auth-title">Create Account</h1>
        <p class="qs-auth-subtitle">Join QualiSense today</p>

        <!-- ERROR BOX -->
        <div id="errorBox" class="alert alert-danger p-2 text-center mb-3" style="display:none;"></div>

        <!-- SIGNUP FORM -->
        <form id="firebase-signup-form">
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input id="signup-email" type="email" class="form-control" placeholder="your@email.com" required>
            </div>

            <div class="mb-3 position-relative">
                <label class="form-label">Password</label>
                <input type="password" id="signup-password" class="form-control" placeholder="Create password" required>

                <i class="bi bi-eye password-toggle"
                   onclick="
                        const p = document.getElementById('signup-password');
                        p.type = p.type === 'password' ? 'text' : 'password';
                   ">
                </i>
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-2">
                Create Account
            </button>
        </form>

        <div class="qs-auth-footer">
            Already have an account? <a href="{% url 'login' %}">Login</a>
        </div>

    </div>
</div>


<!-- ============================= -->
<!-- ðŸ”¥ FIREBASE AUTH MODULES -->
<!-- ============================= -->
<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
        getAuth,
        createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBPjTIFC8czCOm_q6wxSCRH3RkbXQ543gg",
        authDomain: "qualisense-7ee06.firebaseapp.com",
        projectId: "qualisense-7ee06",
        storageBucket: "qualisense-7ee06.appspot.com",
        messagingSenderId: "472417760202",
        appId: "1:472417760202:web:e4bd73815ec632af2bd533"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    function showError(msg) {
        const box = document.getElementById("errorBox");
        box.style.display = "block";
        box.innerText = msg;
    }

    // â­ Send UID & ID Token â†’ Django session_login()
    function sendUIDtoDjango(uid, token) {
        fetch("/session-login/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ uid: uid, token: token })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "ok") {
                window.location.href = "/";
            } else {
                showError("Server session failed.");
            }
        })
        .catch(() => showError("Server error."));
    }


    document.getElementById("firebase-signup-form").addEventListener("submit", function(e) {
        e.preventDefault();

        const email = document.getElementById("signup-email").value;
        const password = document.getElementById("signup-password").value;

        createUserWithEmailAndPassword(auth, email, password)
            .then(async (result) => {

                const uid = result.user.uid;

                // â­ Get Firebase ID Token (IMPORTANT)
                const token = await result.user.getIdToken();

                sendUIDtoDjango(uid, token);
            })
            .catch(error => showError(error.message));
    });

</script>

{% endblock %}
{% block footer %}{% endblock %}
