{% extends "quali_defect_app/base.html" %}
{% load static %}
{% load dict_extras %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'quali_defect_app/css/data_input.css' %}">
<link rel="stylesheet" href="{% static 'quali_defect_app/css/results.css' %}">
<link rel="stylesheet" href="{% static 'quali_defect_app/css/tables.css' %}">
{% endblock %}

{% block content %}

<!-- ================= LOGIN POPUP ================= -->
<div class="modal fade" id="loginPopup" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4">
      <h4 class="text-center fw-bold mb-2">Login Required</h4>
      <p class="text-center text-muted mb-4">Please login or create an account to continue.</p>

      <div class="d-flex justify-content-around mb-3">
        <a href="{% url 'login' %}?next={% url 'data_input' %}" class="btn btn-primary px-4">Login</a>
        <a href="{% url 'signup' %}?next={% url 'data_input' %}" class="btn btn-outline-primary px-4">Sign Up</a>
      </div>
    </div>
  </div>
</div>

<!-- ===================== PAYMENT POPUP ===================== -->
<div class="modal fade" id="paymentPopup" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4">

      <h4 class="text-center fw-bold mb-2">Prediction Limit Reached</h4>
      <p class="text-center text-muted mb-4">
        You have used all available prediction credits.<br>
        Please upgrade your plan to continue.
      </p>

      <div class="d-flex justify-content-around mb-3">
        <a href="{% url 'pricing_page' %}" class="btn btn-primary px-4">View Plans</a>
        <button class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancel</button>
      </div>

    </div>
  </div>
</div>


<div class="container py-5">
  <h2 class="page-title text-center mb-4">Our AI Model</h2>

  <!-- ================= INTRO SECTION ================= -->
  <section id="introSection" class="data-input-card mb-5 animate-fade">

    <div class="row align-items-center gx-5">
      <div class="col-lg-6 mb-4">
        <h1 class="intro-title">AI-Powered Manufacturing Intelligence</h1>
        <p class="intro-subtitle">
          Predict machine failures early and detect defects instantly.
        </p>

        <ul class="intro-list">
          <li>Simple machine readings</li>
          <li>PASS/FAIL output with confidence</li>
          <li>Automatic defect classification</li>
        </ul>

        <div class="d-flex gap-3 mt-4">
          <button id="startModelBtn" class="try-model-btn auth-check">Try Our AI Model</button>
          <button class="demo-video-btn" data-bs-toggle="modal" data-bs-target="#demoVideoModal">
            ▶ Watch Demo Video
          </button>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="row g-3">

          <div class="col-12">
            <div class="intro-info-card">
              <img src="{% static 'quali_defect_app/images/Production_Line.png' %}" class="intro-illustration">
              <div>
                <h5>Production Line Overview</h5>
                <p>Reads essential shop-floor data.</p>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="intro-info-card">
              <img src="{% static 'quali_defect_app/images/Automation_Monitoring.png' %}" class="intro-illustration">
              <div>
                <h5>Automation & Sensors</h5>
                <p>Detects anomalies in real time.</p>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="intro-info-card">
              <img src="{% static 'quali_defect_app/images/Quality_Inspection.png' %}" class="intro-illustration">
              <div>
                <h5>Quality Inspection</h5>
                <p>AI identifies exact defect types.</p>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="intro-flow-card mt-4">
      <h4>How the Dual System Works</h4>
      <div class="intro-steps-grid">
        <div>
          <h6>Step 1 — Machine Health</h6>
          <p>Predict PASS/FAIL from machine readings.</p>
        </div>
        <div>
          <h6>Step 2 — Defect Analysis</h6>
          <p>If FAIL → classify defect type.</p>
        </div>
      </div>
    </div>

  </section>

  {% if error %}
  <div class="alert alert-danger text-center fw-bold">{{ error }}</div>
  {% endif %}

  <!-- ================= MODEL-1 FORM ================= -->
  {% if show_model1_form %}
<div id="model1Section" class="data-input-card mb-5">
  <div class="row">

    <div class="col-md-5 p-4 border-end">
      <h3 class="model-left-title">Machine Health Check</h3>
      <img src="{% static 'quali_defect_app/images/model1_left.png' %}" class="model-left-image">
    </div>

    <div class="col-md-7 p-4">
      <form method="POST" class="auth-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="predict_model1">

        <h4 class="fw-bold mb-3">Enter Machine Configurations</h4>

        <div class="row g-4">

          <div class="col-md-6">
            <label class="form-label">Machine Level</label>
            <select name="Machine_Level" class="form-select form-select-lg">
              <option value="Low" {% if default_model1.Machine_Level == "Low" %}selected{% endif %}>Low</option>
              <option value="Medium" {% if default_model1.Machine_Level == "Medium" %}selected{% endif %}>Medium</option>
              <option value="High" {% if default_model1.Machine_Level == "High" %}selected{% endif %}>High</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Maintenance Indicator</label>
            <select name="Maintenance_Indicator" class="form-select form-select-lg">
              <option value="Yes" {% if default_model1.Maintenance_Indicator == "Yes" %}selected{% endif %}>Yes</option>
              <option value="No" {% if default_model1.Maintenance_Indicator == "No" %}selected{% endif %}>No</option>
            </select>
          </div>

          {% for field in model1_user_fields %}
          <div class="col-md-6">
            <label class="form-label">{{ field }}</label>
            <input type="number"
                   step="any"
                   name="{{ field }}"
                   value="{{ default_model1|get_item:field }}"
                   class="form-control form-control-lg"
                   required>
          </div>
          {% endfor %}

        </div>

        <div class="text-center mt-4">
          <button type="submit" class="analyze-btn px-5 auth-check">Check Health</button>
        </div>

      </form>
    </div>

  </div>
</div>
{% endif %}

  <!-- ================= MODEL-1 RESULT ================= -->
  {% if model1_result %}
  <div class="data-input-card mb-5" id="model1ResultCard">

    <h4 class="fw-bold mb-3">Machine Health Input Summary</h4>

    <div class="table-responsive">
      <table class="table table-bordered text-center">
        <thead class="table-primary fw-bold">
          <tr>
            {% for col in model1_columns_readable %}
              <th>{{ col }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr>
            {% for v in model1_values %}
              <td>{{ v }}</td>
            {% endfor %}
          </tr>
        </tbody>
      </table>
    </div>

    <div class="result-card {% if model1_result.Predicted_Class == 'PASS' %}result-pass{% else %}result-fail{% endif %}">
      <h4>Result: {{ model1_result.Predicted_Class }}</h4>
      <p>Confidence: {{ model1_result.Confidence }}%</p>
    </div>

    {% if model1_recommendations %}
    <div class="recommendation-card mt-4 p-3 bg-light border rounded">
      <h5 class="fw-bold mb-2">Recommended Adjustments</h5>

      <ul class="list-group">
        {% for key, text in model1_recommendations.items %}
          <li class="list-group-item">{{ text }}</li>
        {% endfor %}
      </ul>

      <p class="mt-3">
        <strong>Failure Probability Reduction:</strong>
        {{ model1_failure_reduction }}%
      </p>
    </div>
    {% endif %}

    <div class="text-center mt-4">
      {% if model1_result.Predicted_Class == "FAIL" %}
      <form method="POST" class="d-inline-block">
        {% csrf_token %}
        <input type="hidden" name="action" value="go_model2">
        <button class="proceed-btn auth-check">Proceed to Defect Detection</button>
      </form>
      {% endif %}

      <form method="POST" class="d-inline-block ms-3 auth-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="reset_all">
        <button class="btn btn-secondary px-4 auth-check">Predict Again</button>
      </form>
    </div>
  </div>
{% endif %}

  <!-- ================= MODEL-2 FORM ================= -->
  {% if show_model2_form and not model2_result %}
  <div id="model2Section" class="data-input-card mb-5">

    <div class="row">
      <div class="col-md-5 p-4 border-end">
        <h3 class="model-left-title">Defect Detection</h3>
        <img src="{% static 'quali_defect_app/images/model2_left.png' %}" class="model-left-image">
      </div>

      <div class="col-md-7 p-4">
        <form method="POST" class="auth-form">
          {% csrf_token %}
          <input type="hidden" name="action" value="predict_model2">

          <h4 class="fw-bold mb-3">Enter Further Details</h4>

          <div class="row g-4">

            <div class="col-md-6">
              <label class="form-label">Tool Condition</label>
              <select name="Tool_Condition" class="form-select form-select-lg">
                <option value="Good" {% if default_model2.Tool_Condition == "Good" %}selected{% endif %}>Good</option>
                <option value="Worn" {% if default_model2.Tool_Condition == "Worn" %}selected{% endif %}>Worn</option>
              </select>
            </div>

            {% for field in model2_user_fields %}
              {% if field != "Tool_Condition" %}
              <div class="col-md-6">
                <label class="form-label">{{ field }}</label>
                <input type="number" step="any" name="{{ field }}"
                       value="{{ default_model2|get_item:field }}"
                       class="form-control form-control-lg" required>
              </div>
              {% endif %}
            {% endfor %}

          </div>

          <div class="text-center mt-4">
            <button class="analyze-btn px-5 auth-check">Detect Defect</button>
          </div>

        </form>
      </div>
    </div>

  </div>
  {% endif %}

  <!-- ================= MODEL-2 RESULT ================= -->
  {% if model2_result %}
  <div class="data-input-card mb-5">

    <h4 class="fw-bold mt-4 mb-3">Defect Detection Input Summary</h4>

    <div class="table-responsive">
      <table class="table table-bordered text-center">
        <thead class="table-primary">
          <tr>
            {% for col in model2_columns_readable %}
              <th>{{ col }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr>
            {% for v in model2_values %}
              <td>{{ v }}</td>
            {% endfor %}
          </tr>
        </tbody>
      </table>
    </div>

    <div class="result-card result-info mt-4">
      <h4>Predicted Defect: {{ model2_result.Predicted_Defect }}</h4>
      <p>Confidence: {{ model2_result.Confidence }}%</p>
    </div>

    <h5 class="fw-bold mt-3">Class Probabilities</h5>

    <div class="model2-chart-row">

      <div class="model2-chart-col">
        <h6 class="model2-chart-title">Probability Distribution (Pie)</h6>
        <canvas id="model2Pie" class="chart-medium"></canvas>
      </div>

      <div class="model2-chart-col">
        <h6 class="model2-chart-title">Class Comparison (Bar)</h6>
        <canvas id="model2Bar" class="chart-medium"></canvas>
      </div>

    </div>

    {% if model2_recommendations %}
    <div class="recommendation-card mt-4 p-3 bg-light border rounded">
      <h5 class="fw-bold mb-2">Recommended Adjustments</h5>

      <ul class="list-group">
        {% for rec in model2_recommendations %}
          <li class="list-group-item">{{ rec }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <div class="text-center mt-4">
      <form method="POST" class="auth-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="reset_all">
        <button class="btn btn-secondary px-4 auth-check">Predict Again</button>
      </form>
    </div>

  </div>
  {% endif %}

</div> <!-- END container -->

<!-- ================= VIDEO MODAL ================= -->
<div class="modal fade" id="demoVideoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content demo-video-modal">

      <button type="button" class="demo-video-close" data-bs-dismiss="modal">✕</button>

      <div class="demo-video-wrapper">
        <video id="demoVideoPlayer"
               class="demo-video"
               muted playsinline controls>
          <source src="{% static 'quali_defect_app/video/sample_video.mp4' %}" type="video/mp4">
        </video>
      </div>

    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // ================= BACKEND FLAG FOR PAYMENT =================
  const paymentRequired = {{ payment_required|yesno:"true,false" }};
  const paymentModalEl = document.getElementById("paymentPopup");
  const paymentModal = paymentModalEl ? new bootstrap.Modal(paymentModalEl) : null;

  // ================= LOGIN DETECTION =================
  const isAuth = {{ request.session.firebase_uid|yesno:"true,false" }};
  const loginModalEl = document.getElementById("loginPopup");
  const loginModal = loginModalEl ? new bootstrap.Modal(loginModalEl) : null;

  // ======================= PAYMENT BLOCKER =======================
  function blockIfPaymentNeeded(e) {
      if (paymentRequired) {
          e.preventDefault();
          if (paymentModal) paymentModal.show();
          return true;
      }
      return false;
  }

  // ================= BUTTON PROTECTION =================
  document.querySelectorAll(".auth-check").forEach(btn => {
      btn.addEventListener("click", e => {

          if (!isAuth) {
              e.preventDefault();
              if (loginModal) loginModal.show();
              return;
          }

          blockIfPaymentNeeded(e);
      });
  });

  // ================= FORM PROTECTION =================
  document.querySelectorAll("form.auth-form").forEach(form => {
      form.addEventListener("submit", e => {

          if (!isAuth) {
              e.preventDefault();
              if (loginModal) loginModal.show();
              return;
          }

          blockIfPaymentNeeded(e);
      });
  });

  // ================= INTRO LOGIC =================
  const INTRO_KEY = "qs_intro_started_v1";
  const introSection = document.getElementById("introSection");
  const model1Section = document.getElementById("model1Section");

  if (localStorage.getItem(INTRO_KEY) === "yes") {
    if (introSection) introSection.style.display = "none";
    if (model1Section) model1Section.style.display = "";
  } else {
    if (introSection) introSection.style.display = "";
    if (model1Section) model1Section.style.display = "none";
  }

  const startBtn = document.getElementById("startModelBtn");
  if (startBtn) {
    startBtn.addEventListener("click", () => {
      if (!isAuth) {
        if (loginModal) loginModal.show();
        return;
      }

      if (paymentRequired) {
        if (paymentModal) paymentModal.show();
        return;
      }

      localStorage.setItem(INTRO_KEY, "yes");
      if (introSection) introSection.style.display = "none";
      if (model1Section) model1Section.style.display = "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  }

  // ================= MODEL-2 CHART RENDERING =================
  {% if model2_result %}
  try {
    const labels2 = [{% for p in model2_result.Probabilities %}"{{ p.label }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
    const data2 = [{% for p in model2_result.Probabilities %}{{ p.prob }}{% if not forloop.last %}, {% endif %}{% endfor %}];

    const pieEl = document.getElementById("model2Pie");
    const barEl = document.getElementById("model2Bar");

    if (pieEl) {
      new Chart(pieEl, {
        type: 'doughnut',
        data: { labels: labels2, datasets: [{ data: data2 }] },
        options: { responsive: true }
      });
    }

    if (barEl) {
      new Chart(barEl, {
        type: 'bar',
        data: { labels: labels2, datasets: [{ data: data2 }] },
        options: { responsive: true }
      });
    }
  } catch (err) {}
  {% endif %}

}); // DOMContentLoaded
</script>

{% endblock %}

{% block footer %}{% endblock %}
